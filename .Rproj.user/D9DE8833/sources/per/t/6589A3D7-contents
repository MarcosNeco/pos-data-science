---
title: "Estatística Descritiva"
author: "Cristofer Weber"
date: "25/10/2017"
output:
  html_notebook:
    theme: united
    toc: no
  md_document:
    variant: markdown_github
  slidy_presentation:
    df_print: paged
    duration: 60
    fig_caption: yes
    highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_ALL", "pt_BR")
```

## Mudanças em relação à aula anterior

* Apresentação (**Slidy**) e markdown no mesmo arquivo
* Timer na apresentação
* Timer no meu relógio :)
* Chamada: volta do intervalo (ME LEMBREM SE EU ESQUECER!!!)
* Conteúdo mais prático, mesmo que demande explicações de conteúdos ainda não cobertos
* Mudança na ordem do conteúdo
    + 07/Nov: Análise exploratória com gráficos + Fontes de dados (arquivos, web)
    + 16/Nov: Estatística Inferencial + _Data Science Workflow_

## Sobre os textos

* 4 tópicos de discussão:
    + Razões pelas quais R é utilizado no Airbnb
    + Os papéis de cientistas de dados nos times de software da Microsoft
    + Quais as dificuldades com dados na Microsoft?
    + Importância da visão sistêmica na análise de dados

## Conteúdo

1. Medidas
    + Posição / Localidade
    + Variabilidade / Dispersão

2. Correlação (Na próxima apresentação)

## Medidas

Recapitulando a discussão sobre dados tabulares, temos a definição de uma série de observações (*registros*) que apresentam um mesmo conjunto de variáveis (*features*). 

A quantidade de observações é limitada pela capacidade de coleta (tempo, espaço, custo), de armazenamento, ou pelo tamanho da população. 

> Variáveis, portanto, podem apresentar uma quantidade muito grande de valores.

Utilizamos estatísticas descritivas para resumir e descrever o conjunto de valores que uma variável representa.

```
Nota: Não farei distinção entre população e amostra exceto quando indicado
```

## Dados de exemplo (1)

Relatório de acessos via Blackboard aos textos para leitura extra-classe, por aluno, no intervalo entre 08 e 24 de Outubro de 2017.

**Exercitando a visão sistêmica:**

*Quais possibilidades de acesso não são contempladas por este relatório?*

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)

# A função read_xlsx lê um Data Frame de uma aba de um aquivo Excel.
acessos <- read_xlsx( path = "../data/usage_tracking.xlsx"
                    , sheet = "Item_Tracking"
                    , col_types = c("text", "numeric"))
```

## Dados de exemplo (2)

```{r message=FALSE, warning=FALSE}
# arrange é uma função que ordena um Data Frame em ordem crescente (default) 
# ou decrescente (usando a função desc para indicar)
acessos %>% arrange(desc(Acessos))
```


## Medidas de Posição

Medidas de posição apresentam o valor típico de uma variável

> Uma estimativa do valor típico para a variável


## Média Aritmética

A forma mais básica de cálculo de uma medida de posição é a Média Aritmética.

$$Media = \overline{x} = \frac{\sum _{i=1}^{n}x_{i}}{n}$$
em R:

```{r eval=FALSE}
# Implementação padrão
mean(x, trim = 0, na.rm = FALSE, ...)
```


## Exemplo de Média Aritmética

```{r}
mean(acessos$Acessos)
```

* *Este é um valor realista?*


## Média Aritmética (continuação)

A Média Aritmética enquanto elemento central é o ponto ótimo onde a soma do erro (ou residual) é igual à zero

$$erro = x_{i} - \overline{x} $$

```{r}
round(acessos$Acessos - mean(acessos$Acessos), 4)
```

```{r}
round(sum(acessos$Acessos - mean(acessos$Acessos)), 4)
```

## Média Truncada

Mesma operação de média aritmética, porém com 2 etapas de pré-processamento:

1. Os valores são ordenados
2. **p** valores de cada extremidade são descartados, onde p pode ser tanto uma quantidade quanto um percentual

*Por que descartar valores das extremidades?*

Exemplo, média de acessos descartando 10% de cada extremo
```{r}
mean(acessos$Acessos, trim = .1)
```

## Média Truncada (Validação)

```{r}
# Primeira etapa
# sort ordena um vetor. É uma operação diferente da função arrange apresentada anteriormente
acessos_ordenados <- sort(acessos$Acessos)

# Segunda etapa
# Lembram da função length?
n <- length(acessos_ordenados)
extremes <- n * .1
lo <- extremes + 1 # Por que somei 1?
hi <- n - extremes

acessos_trunc <- acessos_ordenados[lo:hi]

# Média aritmética
mean(acessos_trunc)
```


## Exercício de Média Aritmética

Calcular a média aritmética somente dos alunos que acessaram os textos para leitura extra-classe.

**Lembrem de me enviar este documento com as resoluções dos exercícios**

```{r}
## Código aqui
acessaram_aula <- acessos_ordenados[acessos_ordenados > 0]
mean(acessaram_aula)
```


## Deficiências da Média Aritmética

![](https://mathwithbaddrawings.files.wordpress.com/2016/07/20160712085402_00011.jpg)

## Deficiências da Média Aritmética (2)

![](https://mathwithbaddrawings.files.wordpress.com/2016/07/20160712085402_00012.jpg)

## Deficiências da Média Aritmética (3)

```{r echo=FALSE, warning=FALSE, message=FALSE}
salaries  <- c(rep(30000, 7), 430000)
employees <- c("you", paste("coworker", 1:6), "CEO's son")
 
salaries_table <- 
  data_frame( employees = ordered(employees, levels=sort(employees, decreasing = T))
            , salaries)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
salaries_table %>%
  ggplot(aes( x=employees
            , y=salaries
            , group=employees, colour=employees, fill=employees
            , label=format(salaries, big.mark = "."))) +
  geom_bar(stat="identity", position="dodge") +
  geom_hline(yintercept = mean(salaries_table$salaries), colour="red", linetype="dashed") +
  geom_text( nudge_y = 10000, colour="black" ) +
  scale_y_continuous(breaks = seq(from=0, to=420000, by=30000), labels = function(x) format(x, big.mark=".") ) +
  labs( x="Employees"
      , y="Salaries"
      , title="Why Not to Trust Statistics"
      , subtitle=paste("Uma média de", mean(salaries), "esconde a diferença entre os salários pagos na empresa.")
      , caption = "Fonte: https://mathwithbaddrawings.com/2016/07/13/why-not-to-trust-statistics/")
```

## Mediana

A mediana é o elemento central do conjunto (**ordenado**) de valores de uma variável.

* A figura do elemento central só existe quando o número de observações é ímpar!
* Quando o tamanho for par, o elemento central por definicão será a média entre os dois valores mais ao centro

Em R:
```{r eval=FALSE}
median(x, na.rm = FALSE, ...)
```

Voltando ao gráfico dos salários que vimos anteriormente, qual a mediana dos salários do time?

## Exemplos de mediana (1)

```{r}
median(acessos$Acessos)
```

*Por que o resultado não é um inteiro?*

## Exemplos de mediana (2)

Elemento central dos acessos
```{r}

# Lembram deste operador???
if(n %% 2 == 0) {
  centro <- c(n / 2, n / 2 + 1)
} else {
  centro <- ceiling(n / 2) # ceiling retorna o próximo inteiro maior que o valor informado
}

acessos_ordenados[centro] %>% paste(collapse = ", ")
mean(acessos_ordenados[centro])
```

## Exercício de mediana

Qual a mediana somente dos alunos que acessaram os textos para leitura extra-classe?

```{r}
## Código aqui
median(acessaram_aula)
```

Questão: 

Como você explica a diferença entre os valores obtidos com a Média Aritmética, a Média Aritmética truncada e a Mediana?

```
Resposta: 
```

## O que a Mediana _não_ nos diz?

![](https://mathwithbaddrawings.files.wordpress.com/2016/07/20160712085402_00013.jpg)


## O que a Mediana _não_ nos diz? (2)

![](https://mathwithbaddrawings.files.wordpress.com/2016/07/20160712085402_00014.jpg)


## O que a Mediana _não_ nos diz? (3)
```{r echo=FALSE}
months <- 1:13
rates <- c(10, 8, -40, 8, -40, -50, 8, 10, 8, -35, -50, 8, -40)
 
investment_rates <- data_frame(months, rates)
 
investment_rates %>%
  ggplot(aes(x=months, y=rates, group=rates, colour=months, fill=months)) +
  geom_bar(stat="identity", position="dodge") +
  geom_hline(yintercept = mean(investment_rates$rates), colour="red", linetype="dashed") +
  scale_x_continuous(breaks=1:13) +
  scale_y_continuous(breaks = seq(from=-50, to=10, by=10)) +
  guides(colour=FALSE, fill=FALSE) +
    labs(x="Month", y="Rate (%)")
```
 
 
## O que a Mediana _não_ nos diz? (4)
```{r echo=FALSE}
investment_rates %>%
  arrange(rates) %>%
  add_column(order=seq_along(rates)) %>%
  mutate(position=case_when(.$order < 7 ~ "left", .$order > 7 ~ "right", TRUE ~ "center")) %>%
  dplyr::select(-months) %>%
  ggplot(aes(x=order, y=rates, fill=position, colour=position)) +
  geom_bar(stat="identity", position="dodge") +
  geom_vline(xintercept = 7, colour="red", linetype="dashed") +
  scale_x_continuous(breaks=1:13) +
  scale_y_continuous(breaks = seq(from=-50, to=10, by=10)) +
  guides(colour=FALSE, fill=FALSE) +
  labs(x="Sort Order", y="Rate (%)")
```


## Medidas de Variabilidade

~~Variabilidade~~ Dispersão:

Além de saber o elemento típico do conjunto, é importante conhecer o quanto os valores se aproximam deste elemento típico, ou se estão espalhados/distribuídos em posições distantes do elemento central.

Existem diferentes medidas de dispersão de uso comum, que podemos classificar em 2 grupos:

* Baseadas na Média Aritmética
    + Variância
    + Desvio absoluto da média (aritmética)
    + Desvio Padrão e Coeficiente de Variação
* Baseadas na Mediana
    + Desvio absoluto da mediana
    + Quartis e Intervalo interquartil


## Medidas baseadas na Média

O principal conceito para entendimento do Desvio Padrão e do Desvio Absoluto da Média está relacionado ao cálculo da média em si.

Como vimos anteriormente, a soma dos resíduos é zero. Ao tentar sumarizar as distâncias dos valores em relação à média perdemos a própria noção de distância. Duas formas simples de resolver este problema são a Variância e o Desvio absoluto da média.


## Variância

A variância considera o quadrado do resíduo para eliminar o sinal negativo.

$$Variancia = s^{2} = \frac{1}{n-1} \times \sum_{i=1}^{n}(x_{i} - \overline{x})^{2}$$

Em R:
```{r eval=FALSE}
var(x, y = NULL, na.rm = FALSE, use)
```


## Exemplo da variância

```{r}
var(acessos$Acessos)
```

Como interpretar esta medida?

* Por que calcular a Variância?
    + Desvio Padrão
    + É mais facilmente *derivável*, o que é importante para estimar os parâmetros de um modelo a partir das observações (veremos mais em inferência)
    + Mas qual a relevância para entender a dispersão?

## Desvio médio absoluto

E se, ao invés de elevar o resíduo ao quadrado, utilizarmos o valor absoluto do resíduo?

$$DM = \frac{\sum_{i=1}^{n} \left | x_{i} - \overline{x} \right |}{n}$$

Não existe uma implementação pronta em R, sendo necessário calcular da mesma forma que o algoritmo acima

```{r eval=FALSE}
mean(abs(x-mean(x)))
```


## Exemplo do Desvio médio absoluto

```{r}
mean( abs( acessos$Acessos - mean( acessos$Acessos )))
```

Assim como a média aritmética apresenta o valor típico de uma variável, o Desvio médio absoluto apresenta o valor típico do resíduo.


## Desvio padrão

O desvio padrão é definido pela raíz quadrada da variância:

$$ s = \sqrt{Variance} $$

em R:

```{r eval=FALSE}
sd(x, na.rm = FALSE)
```


## Exemplo de Desvio padrão

```{r}
sd(acessos$Acessos)
```

Desvio padrão é uma medida relativa: quanto maior o desvio padrão, maior a dispersão dos valores.


## Coeficiente de Variação

O desvio padrão também pode ser calculado como uma variação relativa à média, dividindo o desvio padrão pela média:

$$CV = \frac{s}{\overline{x}}$$

Multiplicando o Coeficiente de Variação por 100 temos o percentual de variação. 

```{r}
sd(acessos$Acessos) / mean(acessos$Acessos) * 100
```

Tanto o desvio padrão quanto o coeficiente de variação apontam que há uma grande dispersão nos acessos.


## Dispersão baseada na média

> Para discutirmos: O que significa ter um desvio padrão maior que a média?

```{r echo=FALSE}
acessos %>%
  ggplot(aes(x=Acessos)) +
  geom_bar() +
  geom_vline(xintercept = mean(acessos$Acessos), linetype="dashed") + 
  geom_vline(xintercept = mean(acessos$Acessos) - sd(acessos$Acessos), linetype="dashed") +
  geom_vline(xintercept = mean(acessos$Acessos) + sd(acessos$Acessos), linetype="dashed") +
  scale_x_continuous(breaks=-1:13) +
  scale_y_continuous(breaks=0:12)
```


## Medidas baseadas na Mediana

Vimos nas medidas de posição que a Mediana é mais robusta que a média na presença de _Outliers_

Da mesma forma, as medidas de dispersão baseadas na mediana também não sofrem influência de valores extremos.


## Desvio absoluto da mediana

O desvio absoluto da mediana é definido como a mediana dos resíduos absolutos:

No R:

```{r}
median( abs( acessos$Acessos - median( acessos$Acessos )))
```

Este valor, como o da mediana, pode ser arredondado para manter consistência com a natureza da variável (não existe meio acesso).


## Visualização do Desvio absoluto da mediana

```{r echo=FALSE}
acessos %>%
  ggplot(aes(x=Acessos)) +
  geom_bar() +
  geom_vline(xintercept = median(acessos$Acessos), linetype="dashed") + 
  geom_vline(xintercept = median(acessos$Acessos) - median( abs( acessos$Acessos - median( acessos$Acessos ))), linetype="dashed") +
  geom_vline(xintercept = median(acessos$Acessos) + median( abs( acessos$Acessos - median( acessos$Acessos ))), linetype="dashed") +
  scale_x_continuous(breaks=-1:13) +
  scale_y_continuous(breaks=0:12)
```

## Quartis

Outra forma robusta para obtenção de medidas de dispersão. Ao ordenar os valores de uma variável e dividir em 4 grupos temos 4 quartis que correspondem a 25%, 50%, 75% e 100% dos dados. Qual medida de posição corresponde ao Segundo Quartil? (50%)

Exercício: 

Baseado no desenvolvimento da mediana, desenvolva o cálculo do do Primeiro Quartil (25%) e do Terceiro Quartil (75%)

```{r}
## Código aqui
qtl <- quantile(acessos$Acessos)
qtl[2]
qtl[4]
```


## Função `summary`

A função `summary` apresenta um grupo de estatísticas descritivas. Cobrimos todas elas até aqui:

```{r}
summary(acessos$Acessos)
```

## Amplitude Interquartil

A Amplitude Interquartil corresponde à diferença entre o terceiro e o primeiro quartis. No nosso exemplo de acessos a Amplitude Interquartil é igual ao terceiro quartil, pois o primeiro quartil é zero.

Exercício: Exiba o sumário e determine a Amplitude Interquartil para o subconjunto dos alunos que acessaram os textos para leitura extra-classe.

```{r}
# Seu código aqui
summary(acessos$Acessos)
#aqui nesse caso usei a função pronta que mostra o resultado interquartil
IQR(acessos$Acessos)
```


## Atividade extra-classe: Medidas de Posição e de Dispersão (1)

Analise as medidas dos acessos por hora (arquivo hourly_track.xlsx). Visualize o conteúdo do arquivo como Data Frame (visão tabular) e calcule todas as medidas estudadas em aula. 

Crie até 5 slides para visualização e cálculo das medidas.

Escolha uma medida de Posição e uma medida de Dispersão da sua análise de acessos por hora e descreva sua interpretação de forma resumida (máximo de 2 slides).
 
```{r}
#visão tabular
acessos_hora <- read_xlsx(path = "../data/hourly_track.xlsx",
          sheet = "Sheet1",
          col_types = c("numeric", "numeric"))

acessos_hora_ordered <- sort(acessos_hora$Hits)
acessos_hora  %>% arrange(acessos_hora$Hits)
```
```{r}
# Médica artimética de acesso por hora
mean(acessos_hora$Hits)
```
```{r}
#Média truncada para acessos por hora
mean(acessos_hora_ordered, trim = .2)
```
```{r}
#Mediana acessor por hora
median(acessos_hora_ordered)
```
```{r}
#Desvio padrão dos acessos por hora aos elementos
sd(acessos_hora_ordered)
```
```{r}
#Primeiro Quartil
quantile(acessos_hora_ordered)[2]
#Terceiro Quaril
quantile(acessos_hora_ordered)[4]
```
## Interpretação dos cálculos de média para acesso por hora
 * Através do cálculo de desvio padrão é possível perceber que existe uma variabilidade considerável entre os valores, ou seja, existe valores discrepantes em ambos extremos do conjunto, o que torna o resultado obtido pela mediana como não sendo uma boa representação da média, já que existem vários resultados bem mais altos do que esse.



## Atividade de leitura extra-classe

* Ler o artigo da Wikipedia sobre [Média Geométrica](https://pt.wikipedia.org/wiki/M%C3%A9dia_geom%C3%A9trica)
* Explicar um caso de seu domínio onde o uso da Média Geométrica é aplicável
    + Abrirei espaço no Blackboard para esta explicação
